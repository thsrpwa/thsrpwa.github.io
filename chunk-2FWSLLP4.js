import{a as ue,c as de,d as be,f as fe,g as he}from"./chunk-FPHSEH65.js";import{a as T,b as d,h as P,i as B,j as w}from"./chunk-F4AZ2R32.js";import{e as L,f as ie,g as oe,j as re,m as ne,p as ae,q as se,r as pe,s as le,v as me,w as R,x as ce}from"./chunk-TZ5BZHLV.js";import{a as te}from"./chunk-LW3WONP3.js";import{Ba as Q,Ca as G,Da as O,E as F,Ea as p,Fa as s,Ga as S,Ha as k,J as Y,Ja as f,Ka as g,Kb as h,M as n,Qb as E,S as C,Sa as $,Sb as Z,T as b,Ta as X,Va as u,W as _,Wa as U,Wb as ee,Z as I,a as j,aa as a,b as H,d as Ce,da as m,e as W,ia as N,ka as D,la as z,m as A,pa as J,ua as c,ub as y,wa as K,za as q}from"./chunk-O2LKXLAO.js";var x=Ce(be());var De=["departTripSection"],ke=["returnTripSection"];function Ee(r,i){if(r&1&&(p(0,"option",7),u(1),s()),r&2){let e=i.$implicit;c("value",e),m(),U(e)}}function Le(r,i){if(r&1&&(p(0,"option",7),u(1),s()),r&2){let e=i.$implicit;c("value",e),m(),U(e)}}function Re(r,i){if(r&1){let e=k();p(0,"button",16),f("click",function(){C(e);let o=g();return b(o.onSubmit(o.bookingType.general))}),u(1," \u81EA\u7531\u5EA7\u8A02\u4F4D "),s()}if(r&2){let e=g();c("disabled",e.disableGernalBook())}}function Pe(r,i){if(r&1){let e=k();p(0,"button",16),f("click",function(){C(e);let o=g();return b(o.onSubmit(o.bookingType.general))}),u(1," \u6642\u523B\u8868\u67E5\u8A62 "),s()}if(r&2){let e=g();c("disabled",e.disableGernalBook())}}var ve=[{content:"\u6210\u4EBA",code:"F",isEnable:!0},{content:"\u5B69\u7AE5",code:"H",isEnable:!0},{content:"\u611B\u5FC3",code:"W",isEnable:!0},{content:"\u656C\u8001",code:"E",isEnable:!0},{content:"\u5B78\u751F",code:"P",isEnable:!0},{content:"\u7279\u60E0\u5168",code:"S",isEnable:!0},{content:"\u7279\u60E0\u534A",code:"M",isEnable:!0}],Se=[{name:"\u6A19\u6E96\u8ECA\u5EC2",value:1,disabled:!1},{name:"\u5546\u52D9\u8ECA\u5EC2",value:2,disabled:!1},{name:"\u8F2A\u6905\u5EA7\u4F4D",value:3,disabled:!1}],M=class r{confirm=I();promotions=I();bookingType=ue;form;defaultReturnTime=(0,x.default)().add(1,"day");profiles=a(ve);departStationList=a([]);arrivalStationList=a([]);totalPeople;classType;classTypes=a(Se);promotionTypeList=a([]);promotionDataList=a([]);promotionType;promotionList;roundTrip;personalId=a("");coperateId=a("");selectedPromotion;departTripSection=N("departTripSection");returnTripSection=N("returnTripSection");filteredPromotionDataList=y(()=>{let i=this.promotionType();return this?.promotionDataList()?.filter(e=>e.promotionTypeId===i)});disableGernalBook=y(()=>this.totalPeople()>10);disableGroupBook=y(()=>this.roundTrip()||this.classType()===3||this.selectedPromotion()?.cancel_group_reservation);activatedRoute=n(E);formBuilder=n(me);apiService=n(w);loadingService=n(P);messageService=n(B);destroyRef=n(_);constructor(){this.form=this.formBuilder.group({profiles:this.formBuilder.array(ve.map(()=>this.formBuilder.control(null))),departStation:[null,L.required],arrivalStation:[null,L.required],classType:[Se[0].value,L.required],roundTrip:[!1],promotionType:[0],promotionCodeList:[""],promotionCode:[null]}),this.promotionType=d(this.form.get("promotionType").valueChanges.pipe(A(t=>parseInt(t,10)),F(()=>this.form.patchValue({promotionCodeList:""}))),{initialValue:0}),this.promotionList=d(this.form.get("promotionCodeList").valueChanges.pipe(F(t=>this.form.patchValue({promotionCode:t}))),{initialValue:""}),this.totalPeople=d(this.form.valueChanges.pipe(A(()=>this.form.get("profiles").controls.reduce((t,o)=>t+(o.value||0),0))),{initialValue:0}),this.roundTrip=d(this.form.get("roundTrip").valueChanges),this.classType=d(this.form.get("classType").valueChanges);let i=d(this.form.get("promotionCode").valueChanges);this.selectedPromotion=y(()=>this.promotionDataList()?.find(o=>o.promotionCode===i())??null);let e=!!this.activatedRoute.snapshot.data.unreserved;this.loadingService.start(),this.apiService.startReservation(e).pipe(T(this.destroyRef)).subscribe({next:t=>{this.loadingService.stop(),this.departStationList.set(t.data.departStationList),this.arrivalStationList.set(t.data.arrivalStationList),this.promotionTypeList.set(t.data.promotionOfProjectData&&t.data.promotionOfProjectData.promotionTypeList),this.promotionDataList.set(t.data.promotionOfProjectData&&t.data.promotionOfProjectData.promotionDataList),this.profiles.set(t.data.profile),this.form.setControl("profiles",this.formBuilder.array(t.data.profile.map(o=>this.formBuilder.control({value:null,disabled:!o.isEnable})))),this.classTypes.update(o=>(o.forEach(l=>{let v=t.data.classType?.find(Te=>Te===l.name);l.disabled=!v}),o)),this.form.patchValue({departStation:this.departStationList()[0],arrivalStation:this.arrivalStationList()[1]}),this.promotions.emit(t.data.promotionOfProjectData&&t.data.promotionOfProjectData.promotionDataList)},error:t=>{this.loadingService.stop(),this.messageService.handleError(t)},complete:()=>{this.loadingService.stop()}})}swapStation(){let i=this.form.get("departureStation")?.value,e=this.form.get("arrivalStation")?.value;this.form.get("departureStation")?.setValue(e),this.form.get("arrivalStation")?.setValue(i)}onSubmit(i){if(this.loadingService.loading)return;this.loadingService.start();let e=H(j({},this.form.value),{bookingType:i});e.tripType=e.roundTrip?2:1,e.profile=this.getProfiles(),e.membership={personalId:e.personalId,coperateId:e.coperateId},this.departTripSection()?.mergeValues(e,"depart"),this.returnTripSection()?.mergeValues(e,"return"),e.allTrain=0,e.requeryTrain=!1,e.personalId=this.personalId(),e.coperateId=this.coperateId(),["profiles","promotionType","promotionCodeList","roundTrip"].forEach(t=>{delete e[t]}),this.apiService.queryTrain(e).pipe(T(this.destroyRef)).subscribe({next:t=>{this.loadingService.stop(),this.confirm.emit({query:e,data:t.data})},error:t=>{this.loadingService.stop(),this.messageService.handleError(t)},complete:()=>{this.loadingService.stop()}})}validate(){let i=[];this.form.get("departStation")?.value===this.form.get("arrivalStation")?.value&&i.push("\u51FA\u767C\u7AD9\u8207\u5230\u9054\u7AD9\u9700\u4E0D\u540C");let e=this.getProfiles();e.length>4&&i.push("\u6700\u591A\u53EA\u80FD\u540C\u6642\u8CFC\u8CB7\u56DB\u7A2E\u8EAB\u5206\u5225"),e.length<1&&i.push("\u81F3\u5C11\u9700\u8F38\u5165\u4E00\u500B\u8EAB\u5206\u5225\u7684\u5F35\u6578");let t=Math.max(...e.map(v=>v.quantity));this.form.get("roundTrip")?.value&&t>5&&i.push("\u4E00\u822C\u8A02\u4F4D\u53BB\u56DE\u7A0B\u6700\u591A\u50C5\u80FD\u9078\u64C75\u5F35\u7968");let o=(0,x.default)(`${this.form.get("departDate")?.value} ${this.form.get("departHour")?.value}:${this.form.get("departMinute")?.value}`),l=(0,x.default)(`${this.form.get("returnDate")?.value} ${this.form.get("returnHour")?.value}:${this.form.get("returnMinute")?.value}`);return(l.isBefore(o)||l.isSame(o))&&i.push("\u8A02\u8CFC\u53BB\u56DE\u7A0B\uFF0C\u56DE\u7A0B\u6642\u9593\u65E9\u65BC\u53BB\u7A0B\u6642\u9593"),e.some(v=>v.code==="P")&&this.form.get("classType").value===2&&i.push("\u5B78\u751F\u7968\u4E0D\u9069\u7528\u5546\u52D9\u8ECA\u5EC2\uFF0C\u8ACB\u91CD\u65B0\u9078\u64C7"),i}getProfiles(){let i=this.profiles();return this.form.get("profiles").value.map((e,t)=>({code:i[t].code,quantity:e})).filter(e=>e.quantity)}static \u0275fac=function(e){return new(e||r)};static \u0275cmp=D({type:r,selectors:[["app-step1"]],viewQuery:function(e,t){e&1&&($(t.departTripSection,De,5),$(t.returnTripSection,ke,5)),e&2&&X(2)},outputs:{confirm:"confirm",promotions:"promotions"},decls:23,vars:6,consts:[["departTripSection",""],[1,"py-2",3,"formGroup"],[1,"border","rounded-0","p-3","shadow-sm","bg-white","fs-6","m-0","w-100"],[1,"row","mb-2","align-items-center","w-100","p-3"],["for","departStation",1,"col-auto"],[1,"col"],["id","departStation","formControlName","departStation",1,"form-select","form-select-sm","fs-6"],[3,"value"],[1,"col-auto"],["href","javascript:;",3,"click"],[1,"fa-solid","fa-right-left"],["for","arrivalStation",1,"col-auto"],["id","arrivalStation","formControlName","arrivalStation",1,"form-select","form-select-sm","fs-6"],["title","",1,"mt-0","rounded-0",3,"hasTitle","hasBorder","hasTrainNumber"],[1,"d-flex","align-items-center","gap-2","fs-6","w-100","justify-content-center","mt-2"],["type","button",1,"btn","bg-primary","text-white","px-4",3,"disabled"],["type","button",1,"btn","bg-primary","text-white","px-4",3,"click","disabled"]],template:function(e,t){if(e&1){let o=k();p(0,"form",1)(1,"div",2)(2,"div",3)(3,"label",4),u(4,"\u51FA\u767C\u7AD9"),s(),p(5,"div",5)(6,"select",6),G(7,Ee,2,2,"option",7,Q),s()(),p(9,"div",8)(10,"a",9),f("click",function(){return C(o),b(t.swapStation())}),S(11,"i",10),s()(),p(12,"label",11),u(13,"\u5230\u9054\u7AD9"),s(),p(14,"div",5)(15,"select",12),G(16,Le,2,2,"option",7,Q),s()()(),S(18,"app-trip-section",13,0),s(),p(20,"div",14),J(21,Re,2,1,"button",15)(22,Pe,2,1,"button",15),s()()}e&2&&(c("formGroup",t.form),m(7),O(t.departStationList()),m(9),O(t.arrivalStationList()),m(2),c("hasTitle",!1)("hasBorder",!1)("hasTrainNumber",!1),m(3),q(t.activatedRoute.snapshot.data.unreserved?21:-1),m(),q(t.activatedRoute.snapshot.data.unreserved?-1:22))},dependencies:[h,R,re,pe,le,se,ie,oe,ce,ne,ae,fe],encapsulation:2})};var V=class r{unreserved=a(!1);step=a(1);step1Query=a(null);step1Data=a(null);step4CancelData=a(null);order=new de;mmiService=n(te);messageService=n(B);loadingService=n(P);apiService=n(w);destroyRef=n(_);router=n(Z);activatedRoute=n(E);cancelingBooking=!1;constructor(){let i=!!this.activatedRoute.snapshot.data.unreserved;this.unreserved.set(i),this.mmiService.breadcrumb.set(i?["\u7AD9\u52D9\u54E1\u503C\u73ED","\u81EA\u7531\u5EA7(\u6307\u5B9A\u8ECA\u6B21)","\u67E5\u8A62\u65C5\u7A0B\u73ED\u6B21"]:["\u7AD9\u52D9\u54E1\u503C\u73ED","\u4E00\u822C\u8A02\u4F4D","\u67E5\u8A62\u65C5\u7A0B\u73ED\u6B21"])}onStep1Confirm(i){this.step1Query.set(i.query),this.step1Data.set(i.data),this.step.set(2),this.mmiService.breadcrumb.set(this.unreserved()?["\u7AD9\u52D9\u54E1\u503C\u73ED","\u81EA\u7531\u5EA7(\u6307\u5B9A\u8ECA\u6B21)","\u67E5\u8A62\u65C5\u7A0B\u73ED\u6B21","\u9078\u64C7\u8ECA\u6B21"]:["\u7AD9\u52D9\u54E1\u503C\u73ED","\u4E00\u822C\u8A02\u4F4D","\u67E5\u8A62\u65C5\u7A0B\u73ED\u6B21","\u9078\u64C7\u8ECA\u6B21"])}onStep2Back(){this.step.set(1),this.mmiService.breadcrumb.set(this.unreserved()?["\u7AD9\u52D9\u54E1\u503C\u73ED","\u81EA\u7531\u5EA7(\u6307\u5B9A\u8ECA\u6B21)","\u67E5\u8A62\u65C5\u7A0B\u73ED\u6B21"]:["\u7AD9\u52D9\u54E1\u503C\u73ED","\u4E00\u822C\u8A02\u4F4D","\u67E5\u8A62\u65C5\u7A0B\u73ED\u6B21"])}onStep2Confirm(i){this.order.trip.set(i),this.step.set(3),this.mmiService.breadcrumb.set(this.unreserved()?["\u7AD9\u52D9\u54E1\u503C\u73ED","\u81EA\u7531\u5EA7(\u6307\u5B9A\u8ECA\u6B21)","\u67E5\u8A62\u65C5\u7A0B\u73ED\u6B21","\u9078\u64C7\u8ECA\u6B21","\u9078\u64C7\u5EA7\u4F4D/\u586B\u5BEB\u4E58\u5BA2\u8CC7\u6599"]:["\u7AD9\u52D9\u54E1\u503C\u73ED","\u4E00\u822C\u8A02\u4F4D","\u67E5\u8A62\u65C5\u7A0B\u73ED\u6B21","\u9078\u64C7\u8ECA\u6B21","\u9078\u64C7\u5EA7\u4F4D/\u586B\u5BEB\u4E58\u5BA2\u8CC7\u6599"])}onStep3Confirm(i){this.order.trip.set(i),this.step.set(4),this.mmiService.breadcrumb.set(this.unreserved()?["\u7AD9\u52D9\u54E1\u503C\u73ED","\u81EA\u7531\u5EA7(\u6307\u5B9A\u8ECA\u6B21)","\u67E5\u8A62\u65C5\u7A0B\u73ED\u6B21","\u9078\u64C7\u8ECA\u6B21","\u9078\u64C7\u5EA7\u4F4D/\u586B\u5BEB\u4E58\u5BA2\u8CC7\u6599","\u8A02\u4F4D\u5B8C\u6210"]:["\u7AD9\u52D9\u54E1\u503C\u73ED","\u4E00\u822C\u8A02\u4F4D","\u67E5\u8A62\u65C5\u7A0B\u73ED\u6B21","\u9078\u64C7\u8ECA\u6B21","\u9078\u64C7\u5EA7\u4F4D/\u586B\u5BEB\u4E58\u5BA2\u8CC7\u6599","\u8A02\u4F4D\u5B8C\u6210"])}onStep3Back(){this.step.set(2),this.mmiService.breadcrumb.set(this.unreserved()?["\u7AD9\u52D9\u54E1\u503C\u73ED","\u81EA\u7531\u5EA7(\u6307\u5B9A\u8ECA\u6B21)","\u67E5\u8A62\u65C5\u7A0B\u73ED\u6B21","\u9078\u64C7\u8ECA\u6B21"]:["\u7AD9\u52D9\u54E1\u503C\u73ED","\u4E00\u822C\u8A02\u4F4D","\u67E5\u8A62\u65C5\u7A0B\u73ED\u6B21","\u9078\u64C7\u8ECA\u6B21"])}onStep4Confirm(){this.step.set(5),this.router.navigate(["/mmi/main/payment"])}onStep4Cancel(){this.cancelBooking()}canDeactiveGuard(){return this.step()===4?(this.cancelBooking(),!1):!0}cancelBooking(){return W(this,null,function*(){if(this.cancelingBooking||this.loadingService.loading)return!1;this.cancelingBooking=!0;let i=yield this.messageService.show({title:"\u53D6\u6D88\u8A02\u7968",message:"\u78BA\u5B9A\u53D6\u6D88\u8A02\u7968\u7D00\u9304\uFF1F",confirmation:!0,cancelText:"\u5426",confirmText:"\u662F"}).result;return this.cancelingBooking=!1,i?(this.loadingService.start(),this.apiService.cancelBooking().pipe(T(this.destroyRef)).subscribe({next:e=>{this.loadingService.stop(),this.step4CancelData.set(e.data),this.messageService.setErrors(["\u53D6\u6D88\u8A02\u4F4D\u6210\u529F\uFF01"]),this.step.set(42)},error:e=>{this.loadingService.stop(),this.messageService.handleError(e)},complete:()=>{this.loadingService.stop()}}),!0):!1})}static \u0275fac=function(e){return new(e||r)};static \u0275cmp=D({type:r,selectors:[["app-schedule"]],decls:2,vars:2,consts:[[3,"confirm","promotions"]],template:function(e,t){e&1&&(S(0,"app-errors"),p(1,"app-step1",0),f("confirm",function(l){return t.onStep1Confirm(l)})("promotions",function(l){return t.order.promotions.set(l)}),s()),e&2&&(m(),K("d-none",t.step()!==1))},dependencies:[h,R,M,he],styles:["[_nghost-%COMP%]{display:block;height:100%}"]})};var Be=[{path:"",component:V}],ye=class r{static \u0275fac=function(e){return new(e||r)};static \u0275mod=z({type:r});static \u0275inj=Y({imports:[h,ee.forChild(Be)]})};export{ye as ScheduleModule};
